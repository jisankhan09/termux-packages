name: Generate bootstrap archives (android-7)

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [aarch64, arm]
    
    container:
      image: termux/package-builder:latest
      options: --privileged --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fix permissions
        run: |
          git config --global --add safe.directory /__w/termux-packages/termux-packages
          chown -R builder:builder .

      - name: Setup Android SDK & NDK r29
        run: |
          su builder -c "
            set -e
            export TERMUX_SCRIPTDIR=$(pwd)
            mkdir -p \$HOME/lib
            cd \$HOME/lib

            # Download Android SDK if missing
            if [ ! -d android-sdk ]; then
              wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O sdk.zip
              unzip -q -o sdk.zip -d android-sdk
              rm sdk.zip
            fi

            # Download Android NDK r29 if missing
            if [ ! -d android-ndk ]; then
              wget https://dl.google.com/android/repository/android-ndk-r29-linux.zip -O ndk.zip
              unzip -q -o ndk.zip
              mv android-ndk-r29 android-ndk
              rm ndk.zip
            fi

            export ANDROID_HOME=\$HOME/lib/android-sdk
            export NDK=\$HOME/lib/android-ndk
            export PATH=\$ANDROID_HOME/cmdline-tools/latest/bin:\$PATH

            echo 'Android SDK and NDK r29 installed successfully'
          "

      - name: Build bootstrap archive
        run: |
          su builder -c "
            set -e
            export TERMUX_SCRIPTDIR=$(pwd)
            export ANDROID_HOME=\$HOME/lib/android-sdk
            export NDK=\$HOME/lib/android-ndk

            # Change default package name
            sed -i 's/com.termux/com.vault.fide/g' ./scripts/properties.sh

            # Fix hardcoded paths in build script
            sed -i \"s|/home/builder/termux-packages|\$TERMUX_SCRIPTDIR|g\" ./scripts/build-bootstraps.sh

            # Setup Ubuntu build tools
            ./scripts/setup-ubuntu.sh

            # Build bootstrap for this arch
            ./scripts/build-bootstraps.sh --architectures ${{ matrix.arch }}
          "

      - name: Upload bootstrap artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-${{ matrix.arch }}
          path: "*.zip"

  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download bootstrap artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Create release and upload artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tag_name="bootstrap-$(date +'%Y.%m.%d-%H%M')"
          gh release create "$tag_name" \
            --title "Bootstrap for com.vault.fide - $(date +'%Y-%m-%d')" \
            --notes "Automated build for Androidâ€‘7 legacy support"
          if ls ./artifacts/*.zip 1> /dev/null 2>&1; then
            gh release upload "$tag_name" ./artifacts/*.zip
          else
            echo "No zip files found!"
            exit 1
          fi
